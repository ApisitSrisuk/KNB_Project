<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>ใบกำกับภาษี</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@200;300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script defer src="/_vercel/insights/script.js"></script>
    <style>
      @page {
        size: A4;
        margin: 10mm;
      }
      * {
        font-family: "Sarabun", Arial, sans-serif;
      }
      body {
        background: #f0f2f5;
        padding: 0;
        margin: 0;
        -webkit-print-color-adjust: exact;
      }

      .invoice-box {
        background: #fff;
        /* width: 190mm; */
        /* max-width: 100%; */
        margin: 0 auto;
        padding: 16mm;
        /* border-radius: 6px; */
        /* border: 1px solid #e1e4e8; */
        /* box-shadow: 0 2px 8px rgba(0,0,0,0.06); */
        /* box-sizing: border-box; */
        color: #222;
        font-size: 14px;
      }

      .header {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
        position: relative;
      }

      .company-info {
        line-height: 1.6;
        text-align: left;
        max-width: calc(100% - 140px);
      }

      .company-info h2 {
        margin: 0;
      }

      .logo {
        position: absolute;
        left: 1mm;
        top: 50%;
        transform: translateY(-50%);
      }

      .logo img {
        max-width: 120px;
      }

      .title {
        text-align: center;
        font-size: 20px;
        margin: 14px 0;
        font-weight: 700;
        color: #0b3b66;
      }

      .info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 13px;
      }

      table,
      th,
      td {
        border: 1px solid #d7dbe0;
      }

      th {
        background: #f6f8fa;
        color: #233444;
        padding: 10px;
        font-weight: 600;
        text-align: center;
      }

      td {
        padding: 10px;
        vertical-align: middle;
      }

      td.text-right {
        text-align: right;
      }
      td.text-left {
        text-align: left;
      }
      tr:nth-child(even) td {
        background: #fff;
      }

      .summary {
        margin-top: 18px;
        width: 40%;
        float: right;
        border: none;
      }

      .summary td {
        text-align: right;
        padding: 8px 10px;
        border: none;
      }

      .summary tr td:first-child {
        color: #333;
      }

      .info,
      .header .company-info {
        font-size: 13px;
        color: #333;
      }

      .footer {
        clear: both;
        margin-top: 40px;
        display: flex;
        justify-content: space-between;
        text-align: center;
      }

      .signature {
        width: 45%;
        color: #444;
      }

      .signature .line {
        display: block;
        margin-top: 28px;
        border-top: 1px solid #bbb;
        padding-top: 6px;
      }

      .btn {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 6px;
        border: none;
        background: #1e88e5;
        color: #fff;
        margin: 0 5px;
        transition: background 0.3s;
      }

      .btn.secondary {
        background: #6c757d;
      }

      .no-print {
      }

      /* Editable field styling */
      .editable,
      input[type="text"],
      input[type="number"],
      textarea {
        padding: 8px 10px;
        border: 1px solid #e6edf3;
        border-radius: 6px;
        background: #fbfdff;
        font-size: 13px;
        color: #112233;
        box-shadow: inset 0 1px 2px rgba(16, 24, 40, 0.03);
        transition:
          box-shadow 0.12s ease,
          border-color 0.12s ease,
          background 0.12s;
      }

      .editable:focus,
      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus {
        outline: none;
        border-color: #7aa7ff;
        box-shadow: 0 0 0 4px rgba(30, 136, 229, 0.08);
        background: #fff;
      }

      input.item-qty,
      input.item-price {
        width: 90px;
        text-align: right;
      }
      /* allow multi-line descriptions */
      .item-desc {
        width: 100%;
        box-sizing: border-box;
        resize: vertical;
        min-height: 44px;
      }
      ::placeholder {
        color: #9aa6b2;
      }

      /* Radio/label spacing */
      label {
        margin-right: 12px;
      }
      #paymentContainer div {
        display: inline-block;
      }

      /* Slight emphasis for key fields */
      #customerName,
      #docNumber {
        font-weight: 600;
      }

      @media print {
        body {
          background: #fff;
          padding: 0;
        }
        .no-print {
          display: none !important;
        }
        .invoice-box {
          box-shadow: none;
          border: none;
          margin: 0;
          width: 100%;
          padding: 10mm;
        }
        table,
        th,
        td {
          border: none !important;
        }
        .row-remove-btn {
          display: none !important;
        }
        input,
        textarea,
        select {
          border: none !important;
          box-shadow: none !important;
          background: transparent !important;
        }
      }

      /* styles applied while exporting to remove interactive chrome */
      .invoice-box.exporting table,
      .invoice-box.exporting th,
      .invoice-box.exporting td {
        border: none !important;
      }
      .invoice-box.exporting input,
      .invoice-box.exporting textarea,
      .invoice-box.exporting select {
        border: none !important;
        box-shadow: none !important;
        background: transparent !important;
      }
      .invoice-box.exporting .row-remove-btn {
        display: none !important;
      }

      /* Payment section styling */
      .payment-row {
        margin-top: 14px;
        display: flex;
        gap: 16px;
        align-items: flex-start;
        flex-wrap: wrap;
      }
      .payment-fields {
        background: #f8fbff;
        border: 1px solid #e3eefc;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(16, 24, 40, 0.03);
        width: 100%;
      }
      .payment-fields .row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .payment-fields label {
        font-weight: 600;
        color: #0b3b66;
      }
      .remark-box {
        background: #fff7e6;
        border-left: 4px solid #ff9800;
        padding: 10px;
        border-radius: 6px;
        color: #6b4b00;
        white-space: pre-line;
      }
      .remark-box.readonly {
        cursor: default;
      }
      .remark-box.editable {
        background: #f7f9fc;
        border-left: 4px solid #1976d2;
        color: #073e6b;
      }
      input[type="date"] {
        padding: 6px 8px;
        border-radius: 4px;
      }
      textarea {
        min-height: 64px;
        max-height: 200px;
        resize: vertical;
      }
      /* Navbar styles */
      .navbar {
        background: linear-gradient(135deg, #0b3b66 0%, #1565c0 100%);
        padding: 0;
        margin: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      .navbar-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .navbar-brand {
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        text-decoration: none;
      }
      .navbar-menu {
        display: flex;
        gap: 20px;
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .navbar-menu a {
        color: #fff;
        text-decoration: none;
        font-size: 14px;
        padding: 6px 12px;
        border-radius: 4px;
        transition: background 0.3s;
      }
      .navbar-menu a:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      @media print {
        .navbar {
          display: none !important;
        }
      }
    </style>
    <link rel="icon" type="image/x-icon" href="/logo.png">
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar no-print">
      <div class="navbar-container">
        <a href="#" class="navbar-brand">บริษัท เคเอ็นบี อินเตอร์เนชั่นแนล</a>
        <ul class="navbar-menu">
          <!-- <li><a href="#">หน้าแรก</a></li> -->
          <li><a href="#">ใบกำกับภาษี</a></li>
          <li><a href="/public/billRecipe.html">ใบสำคัญการซื้อขาย</a></li>
          <!-- <li><a href="#">ออกจากระบบ</a></li> -->
        </ul>
      </div>
    </nav>
    <br>
    <div style="text-align: center; margin-bottom: 10px">
      <button class="btn no-print" onclick="exportPDFs()">ดาวน์โหลด PDF</button>
      <button class="btn secondary no-print" onclick="addItem()">
        เพิ่มรายการ
      </button>
    </div>
    <div id="invoice" class="invoice-box">
      <!-- Header -->
      <div class="header">
        <div class="company-info">
          <h2>บริษัท เคเอ็นบี อินเตอร์เนชั่นแนล จำกัด</h2>
          ร้าน เคเอ็นบี มอเตอร์ (สาขา 2) <br />
          ที่อยู่: 2/97-98 ม.1 ต.บางริ้น <br />
          อ.เมืองระนอง จ.ระนอง 85000<br />
          เบอร์โทร : 081-256-3627<br />
          เลขประจำตัวผู้เสียภาษี : 0215565007664<br />
        </div>

        <div class="logo">
          <img src="images/logo.png" alt="Company Logo" />
        </div>
      </div>

      <div class="title">ใบเสร็จรับเงิน/ใบกำกับภาษี</div>
      <div class="title" style="font-size: 13px">
        RECEIPT / TAX INVOICE
        <div
          id="docTypeLabel"
          style="font-size: 14px; margin-top: 6px; color: #555"
        ></div>
      </div>

      <!-- Customer Info -->
      <div class="info">
        <div>
          <strong>ชื่อลูกค้า:</strong>
          <input
            type="text"
            id="customerName"
            class="editable"
            value="บริษัท ตัวอย่าง จำกัด"
          /><br />
          <strong>ที่อยู่:</strong>
          <input
            type="text"
            id="customerAddress"
            class="editable"
            value="99 ถนนพระราม 9 กรุงเทพฯ"
          /><br />
          <strong>เลขผู้เสียภาษี:</strong>
          <input
            type="text"
            id="customerTaxId"
            class="editable"
            value="0105559876543"
          />
        </div>
        <div>
          <strong>เลขที่เอกสาร:</strong>
          <input
            type="text"
            id="docNumber"
            class="editable"
            value="INV-2026-001"
          /><br />
          <strong>วันที่:</strong>
          <input type="text" id="docDate" class="editable" value="12/01/2026" />
        </div>
      </div>

      <!-- Item Table -->
      <table>
        <thead>
          <tr>
            <th>ลำดับ</th>
            <th>รายการ</th>
            <th>จำนวน</th>
            <th>ราคา/หน่วย</th>
            <th>จำนวนเงิน</th>
            <th>จัดการ</th>
          </tr>
        </thead>
        <tbody id="items">
          <!-- rows inserted dynamically -->
        </tbody>
      </table>

      <!-- Summary -->
      <table class="summary">
        <tr>
          <td>รวมเป็นเงิน</td>
          <td id="subTotal">0.00</td>
        </tr>
        <tr>
          <td>ภาษีมูลค่าเพิ่ม 7%</td>
          <td id="vatAmount">0.00</td>
        </tr>
        <tr>
          <td><strong>ยอดสุทธิ</strong></td>
          <td id="grandTotal"><strong>0.00</strong></td>
        </tr>
      </table>

      <!-- Payment Method -->
      <div id="paymentContainer" style="clear: both; margin-top: 20px">
        <strong>วิธีการชำระเงิน:</strong><br />
        <label
          ><input
            type="radio"
            name="paymentMethod"
            value="cash"
            checked
            onchange="setPaymentMethod()"
          />
          เงินสด</label
        >
        <label
          ><input
            type="radio"
            name="paymentMethod"
            value="cheque"
            onchange="setPaymentMethod()"
          />
          เช็ค</label
        >
        <label
          ><input
            type="radio"
            name="paymentMethod"
            value="transfer"
            onchange="setPaymentMethod()"
          />
          โอนบัญชีธนาคาร</label
        >

        <div
          id="chequeFields"
          class="payment-fields"
          style="display: none; margin-top: 10px"
        >
          <div class="row">
            <label>หมายเลขเช็ค:</label>
            <input type="text" id="chequeNumber" />
            <label>ธนาคาร:</label>
            <input type="text" id="chequeBank" />
            <label>วันที่รับเช็ค:</label>
            <input type="date" id="chequeDate" />
          </div>
          <div style="margin-top: 4px">
            <div style="font-size: 13px; color: #6b6b6b; margin-bottom: 6px">
              หมายเหตุ
            </div>
            <textarea
              id="chequeRemark"
              rows="3"
              class="remark-box readonly"
              style="width: 100%; box-sizing: border-box"
              readonly
              tabindex="-1"
            >
ในกรณีรับเช็ค ใบเสร็จรับเงินฉบับนี้จะสมบูรณ์ ต่อเมื่อเช็คได้ผ่านการเรียกเก็บจากธนาคารแล้วเท่านั้น Payment will be vilid only when the cheque has benn honoured by bank.</textarea
            >
          </div>
        </div>

        <div
          id="transferFields"
          class="payment-fields"
          style="display: none; margin-top: 10px"
        >
          <div class="row">
            <label>ธนาคาร:</label>
            <input type="text" id="transferBank" />
            <label>เลขที่บัญชี:</label>
            <input type="text" id="transferAccount" />
            <label>วันที่โอน:</label>
            <input type="date" id="transferDate" />
          </div>
          <!-- <div style="margin-top:4px">
            <div style="font-size:13px; color:#6b6b6b; margin-bottom:6px">หมายเหตุ (สามารถแก้ไขได้)</div>
            <textarea id="transferRemark" rows="3" class="remark-box editable" style="width:100%; box-sizing:border-box"></textarea>
          </div> -->
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <div class="signature">
          ___________________________<br />
          ผู้ซื้อสินค้า
        </div>
        <div class="signature">
          ___________________________<br />
          ผู้มีอำนาจลงนาม
        </div>
      </div>
    </div>

    <script>
      const today = new Date();
      const day = String(today.getDate()).padStart(2, "0");
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const year = today.getFullYear(); // ใช้เป็นปี ค.ศ. (2026)

      const dateStr = `${year}${month}${day}`;
      const fullDocNumber = `INV-${dateStr}-001`;
      document.getElementById("docDate").value = `${day}/${month}/${year}/`;
      document.getElementById("docNumber").value = fullDocNumber;
      function formatNumber(num) {
        return Number(num).toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      function addItem(desc = "", qty = 1, price = 0) {
        const tbody = document.getElementById("items");
        const row = document.createElement("tr");
        row.innerHTML = `
      <td class="item-index"></td>
      <td><textarea class="item-desc">${desc}</textarea></td>
      <td><input class="item-qty" type="number" min="0" value="${qty}"></td>
      <td><input class="item-price" type="number" min="0" step="0.01" value="${price}"></td>
      <td class="item-amount">0.00</td>
      <td><button class="no-print row-remove-btn" onclick="removeItem(this)">ลบ</button></td>
    `;
        tbody.appendChild(row);
        attachRowEvents(row);
        updateIndices();
        updateTotals();
      }

      function attachRowEvents(row) {
        const qty = row.querySelector(".item-qty");
        const price = row.querySelector(".item-price");
        const desc = row.querySelector(".item-desc");
        [qty, price, desc].forEach((el) =>
          el.addEventListener("input", updateTotals),
        );
      }

      function removeItem(btn) {
        const row = btn.closest("tr");
        row.remove();
        updateIndices();
        updateTotals();
      }

      function updateIndices() {
        document.querySelectorAll("#items tr").forEach((r, i) => {
          const idx = r.querySelector(".item-index");
          if (idx) idx.textContent = i + 1;
        });
      }

      function updateTotals() {
        let subtotal = 0;
        document.querySelectorAll("#items tr").forEach((r) => {
          const q = parseFloat(r.querySelector(".item-qty").value) || 0;
          const p = parseFloat(r.querySelector(".item-price").value) || 0;
          const amt = q * p;
          r.querySelector(".item-amount").textContent = formatNumber(amt);
          subtotal += amt;
        });
        const vat = subtotal * 0.07;
        const total = subtotal + vat;
        document.getElementById("subTotal").textContent =
          formatNumber(subtotal);
        document.getElementById("vatAmount").textContent = formatNumber(vat);
        document.getElementById("grandTotal").textContent = formatNumber(total);
      }

      function setPaymentMethod() {
        const method = document.querySelector(
          "input[name=paymentMethod]:checked",
        ).value;
        const chequeEl = document.getElementById("chequeFields");
        const transferEl = document.getElementById("transferFields");
        chequeEl.style.display = method === "cheque" ? "block" : "none";
        transferEl.style.display = method === "transfer" ? "block" : "none";
        if (method === "cheque") {
          const chkRemark = document.getElementById("chequeRemark");
          if (chkRemark && !chkRemark.value.trim()) {
            chkRemark.value =
              "ในกรณีรับเช็ค ใบเสร็จรับเงินฉบับนี้จะสมบูรณ์ ต่อเมื่อเช็คได้ผ่านการเรียกเก็บจากธนาคารแล้วเท่านั้น";
          }
        }
      }

      // Prepare export: replace interactive inputs/radios with plain text for accurate PDF rendering
      let __exportBackups = [];
      function prepareForExport() {
        __exportBackups = [];
        const invoice = document.getElementById("invoice");

        // Backup and replace payment container with summary text
        const paymentContainer = document.getElementById("paymentContainer");
        if (paymentContainer) {
          __exportBackups.push({
            node: paymentContainer,
            html: paymentContainer.innerHTML,
          });
          const method = document.querySelector(
            "input[name=paymentMethod]:checked",
          );
          let text = "";
          if (method) {
            if (method.value === "cash") text = "เงินสด";
            else if (method.value === "cheque") text = "เช็ค";
            else if (method.value === "transfer") text = "โอนบัญชีธนาคาร";
          }
          if (method && method.value === "cheque") {
            const num = document.getElementById("chequeNumber").value || "";
            const bank = document.getElementById("chequeBank").value || "";
            let date = document.getElementById("chequeDate")
              ? document.getElementById("chequeDate").value || ""
              : "";
            const remark = document.getElementById("chequeRemark")
              ? document.getElementById("chequeRemark").value || ""
              : "";
            date = formatDateForExport(date);
            if (num || bank) text += " — " + num + (bank ? " / " + bank : "");
            if (date) text += (text ? "\n" : " — ") + "วันที่รับเช็ค: " + date;
            if (remark) text += "\n" + remark;
          }
          if (method && method.value === "transfer") {
            const bank = document.getElementById("transferBank").value || "";
            const acc = document.getElementById("transferAccount").value || "";
            let date = document.getElementById("transferDate")
              ? document.getElementById("transferDate").value || ""
              : "";
            const remark = document.getElementById("transferRemark")
              ? document.getElementById("transferRemark").value || ""
              : "";
            date = formatDateForExport(date);
            if (bank || acc) text += " — " + bank + (acc ? " / " + acc : "");
            if (date) text += (text ? "\n" : " — ") + "วันที่โอน: " + date;
            if (remark) text += "\n" + remark;
          }
          paymentContainer.innerHTML =
            '<div style="margin-top:6px; white-space:pre-line">' +
            text +
            "</div>";
        }

        // remove interactive/remove buttons from export view
        invoice
          .querySelectorAll(".row-remove-btn, .no-print")
          .forEach((el) => el.remove());
        // remove the last "จัดการ" column only from the items table (do not touch summary table)
        const itemsTable = document.querySelector("#items")
          ? document.querySelector("#items").closest("table")
          : null;
        if (itemsTable) {
          const thead = itemsTable.querySelector("thead");
          if (thead) {
            const lastTh = thead.querySelector("th:last-child");
            if (lastTh && /จัดการ/.test(lastTh.textContent)) lastTh.remove();
          }
          itemsTable.querySelectorAll("tr").forEach((tr) => {
            const lastTd = tr.querySelector("td:last-child");
            if (lastTd) lastTd.remove();
          });
        }

        // Replace all inputs (except buttons/no-print) with text nodes
        const inputs = invoice.querySelectorAll("input, textarea, select");
        inputs.forEach((inp, idx) => {
          // skip if inside paymentContainer (already handled)
          if (paymentContainer && paymentContainer.contains(inp)) return;
          if (inp.classList && inp.classList.contains("no-print")) return;
          // create span
          const span = document.createElement("span");
          let value = "";
          if (inp.type === "checkbox" || inp.type === "radio") {
            if (inp.checked) {
              // try to get label text
              const lbl = invoice.querySelector('label[for="' + inp.id + '"]');
              value = inp.value || (lbl ? lbl.textContent : "เลือก");
            } else return; // unchecked radios/checkboxes omitted
          } else {
            value = inp.value || "";
          }
          span.textContent = value;
          span.className = "exported-text";
          const id = "exp" + (__exportBackups.length + 1);
          span.dataset.exportId = id;
          // store current value and span reference so we can restore with the current value
          __exportBackups.push({
            node: inp,
            exportId: id,
            html: inp.outerHTML,
            parent: inp.parentNode,
            next: inp.nextSibling,
            value: inp.value,
            checked: inp.checked,
            type: inp.type,
            span: span,
          });
          inp.parentNode.replaceChild(span, inp);
        });

        // Replace item row inputs as well (they are captured above)
      }

      // format yyyy-mm-dd -> dd/mm/yyyy for export readability
      function formatDateForExport(dateStr) {
        if (!dateStr) return "";
        if (dateStr.indexOf("/") !== -1) return dateStr;
        const parts = dateStr.split("-");
        if (parts.length === 3)
          return parts[2] + "/" + parts[1] + "/" + parts[0];
        return dateStr;
      }

      function restoreAfterExport() {
        // restore in reverse order
        for (let i = __exportBackups.length - 1; i >= 0; i--) {
          const b = __exportBackups[i];
          if (b.exportId) {
            const parent = b.parent;
            // recreate original input from stored outerHTML
            const frag = document
              .createRange()
              .createContextualFragment(b.html);
            if (b.next) parent.insertBefore(frag, b.next);
            else parent.appendChild(frag);
            // set the restored input's current value (preserve user edits)
            try {
              // find the first input/select/textarea in the inserted fragment or the inserted node itself
              const restored = b.next
                ? parent.previousSibling
                : parent.lastElementChild;
              if (restored) {
                let newInput = null;
                if (restored.nodeType === 1) {
                  const tag =
                    restored.tagName && restored.tagName.toLowerCase();
                  if (tag === "input" || tag === "textarea" || tag === "select")
                    newInput = restored;
                  else if (restored.querySelector)
                    newInput = restored.querySelector(
                      "input, textarea, select",
                    );
                }
                if (newInput && b.value !== undefined) newInput.value = b.value;
                // restore checked state for radios/checkboxes
                if (newInput && (b.type === "radio" || b.type === "checkbox")) {
                  try {
                    newInput.checked = !!b.checked;
                  } catch (e) {}
                }
              }
            } catch (e) {}
            // remove the replacement span if still present
            const s = parent.querySelector(
              '[data-export-id="' + b.exportId + '"]',
            );
            if (s) s.remove();
          } else if (b.node) {
            // paymentContainer backup
            b.node.innerHTML = b.html;
          }
        }
        // reattach events and recalc after restoring inputs
        document
          .querySelectorAll("#items tr")
          .forEach((r) => attachRowEvents(r));
        updateIndices();
        updateTotals();
        try {
          setPaymentMethod();
        } catch (e) {}
        __exportBackups = [];
      }

      function validateBeforeExport() {
        const method = document.querySelector(
          "input[name=paymentMethod]:checked",
        ).value;
        if (method === "cheque") {
          const num = document.getElementById("chequeNumber").value.trim();
          const bank = document.getElementById("chequeBank").value.trim();
          if (!num || !bank) {
            alert("กรุณากรอกหมายเลขเช็คและชื่อธนาคาร");
            return false;
          }
        }
        if (method === "transfer") {
          const bank = document.getElementById("transferBank").value.trim();
          const acc = document.getElementById("transferAccount").value.trim();
          if (!bank || !acc) {
            alert("กรุณากรอกข้อมูลธนาคารและเลขที่บัญชีสำหรับการโอน");
            return false;
          }
        }
        // at least one item
        if (document.querySelectorAll("#items tr").length === 0) {
          if (!confirm("ไม่มีรายการสินค้า: ต้องการส่งออกหรือไม่?"))
            return false;
        }
        return true;
      }

      function exportPDFWithLabel(label, filename) {
        return new Promise((resolve) => {
          const element = document.getElementById("invoice");
          document.getElementById("docTypeLabel").textContent = label;
          // prepare: convert interactive controls to text for PDF
          prepareForExport();
          element.classList.add("exporting");
          // small timeout to allow DOM updates
          setTimeout(() => {
            html2pdf()
              .from(element)
              .set({
                margin: 10,
                filename: filename,
                html2canvas: { scale: 2 },
                jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
              })
              .save()
              .then(() => {
                element.classList.remove("exporting");
                // restore original interactive controls
                restoreAfterExport();
                resolve();
              })
              .catch((err) => {
                element.classList.remove("exporting");
                restoreAfterExport();
                resolve();
              });
          }, 250);
        });
      }

      async function exportPDFs() {
        updateTotals();
        if (!validateBeforeExport()) return;
        // use document number as filename if available
        const docNum = fullDocNumber;

        const safeName = (docNum + "")
          .replace(/[^a-zA-Z0-9-_\.ก-๙\s]/g, "_")
          .trim();
        const filename = safeName + ".pdf";
        try {
          // create two printable clones (original + copy) with identical data
          const origEl = document.getElementById("invoice");

          function syncInputValues(source, target) {
            const srcInputs = source.querySelectorAll(
              "input, textarea, select",
            );
            const tgtInputs = target.querySelectorAll(
              "input, textarea, select",
            );
            for (let i = 0; i < srcInputs.length; i++) {
              const s = srcInputs[i];
              const t = tgtInputs[i];
              if (!t) continue;
              try {
                if (s.type === "checkbox" || s.type === "radio") {
                  t.checked = s.checked;
                } else {
                  t.value = s.value;
                }
                if (s.tagName && s.tagName.toLowerCase() === "select") {
                  t.value = s.value;
                }
              } catch (e) {}
            }
          }

          function prepareCloneForExport(clone, label, emphasizeLabel) {
            // set label inside clone
            const lbl = clone.querySelector("#docTypeLabel");
            if (lbl) {
              lbl.textContent = label;
              if (emphasizeLabel) {
                lbl.style.fontSize = "18px";
                lbl.style.fontWeight = "800";
                lbl.style.color = "#fffff";
              }
            }

            // remove interactive/remove buttons from clone so they won't be exported
            clone
              .querySelectorAll(".row-remove-btn, .no-print")
              .forEach((el) => el.remove());
            // remove the last "จัดการ" column in the clone's items table only
            const cloneItems = clone.querySelector("#items")
              ? clone.querySelector("#items").closest("table")
              : null;
            if (cloneItems) {
              const thead2 = cloneItems.querySelector("thead");
              if (thead2) {
                const lastTh2 = thead2.querySelector("th:last-child");
                if (lastTh2 && /จัดการ/.test(lastTh2.textContent))
                  lastTh2.remove();
              }
              cloneItems.querySelectorAll("tr").forEach((tr) => {
                const lastTd2 = tr.querySelector("td:last-child");
                if (lastTd2) lastTd2.remove();
              });
            }

            // ensure payment summary inside clone includes full details
            const paymentContainer = clone.querySelector("#paymentContainer");
            if (paymentContainer) {
              const method = clone.querySelector(
                "input[name=paymentMethod]:checked",
              );
              let text = "";
              if (method) {
                if (method.value === "cash") text = "เงินสด";
                else if (method.value === "cheque") text = "เช็ค";
                else if (method.value === "transfer") text = "โอนบัญชีธนาคาร";
              }
              if (method && method.value === "cheque") {
                const num = clone.querySelector("#chequeNumber")
                  ? clone.querySelector("#chequeNumber").value || ""
                  : "";
                const bank = clone.querySelector("#chequeBank")
                  ? clone.querySelector("#chequeBank").value || ""
                  : "";
                let date = clone.querySelector("#chequeDate")
                  ? clone.querySelector("#chequeDate").value || ""
                  : "";
                const remark = clone.querySelector("#chequeRemark")
                  ? clone.querySelector("#chequeRemark").value || ""
                  : "";
                date = formatDateForExport(date);
                if (num || bank)
                  text += " — " + num + (bank ? " / " + bank : "");
                if (date)
                  text += (text ? "\n" : " — ") + "วันที่รับเช็ค: " + date;
                if (remark) text += "\n" + remark;
              }
              if (method && method.value === "transfer") {
                const bank = clone.querySelector("#transferBank")
                  ? clone.querySelector("#transferBank").value || ""
                  : "";
                const acc = clone.querySelector("#transferAccount")
                  ? clone.querySelector("#transferAccount").value || ""
                  : "";
                let date = clone.querySelector("#transferDate")
                  ? clone.querySelector("#transferDate").value || ""
                  : "";
                const remark = clone.querySelector("#transferRemark")
                  ? clone.querySelector("#transferRemark").value || ""
                  : "";
                date = formatDateForExport(date);
                if (bank || acc)
                  text += " — " + bank + (acc ? " / " + acc : "");
                if (date) text += (text ? "\n" : " — ") + "วันที่โอน: " + date;
                if (remark) text += "\n" + remark;
              }
              paymentContainer.innerHTML =
                '<div style="margin-top:6px; white-space:pre-line">' +
                text +
                "</div>";
            }

            // replace inputs in clone with spans (static text)
            const inputs = clone.querySelectorAll("input, textarea, select");
            inputs.forEach((inp) => {
              if (inp.classList && inp.classList.contains("no-print")) return;
              const span = document.createElement("span");
              let value = "";
              if (inp.type === "checkbox" || inp.type === "radio") {
                if (inp.checked) {
                  const lbl = clone.querySelector(
                    'label[for="' + inp.id + '"]',
                  );
                  value = inp.value || (lbl ? lbl.textContent : "เลือก");
                } else return;
              } else {
                value = inp.value || "";
              }
              span.textContent = value;
              span.style.whiteSpace = "pre-line";
              inp.parentNode.replaceChild(span, inp);
            });
          }

          // build wrapper with two clones
          const wrapper = document.createElement("div");
          // set wrapper width to printable A4 width minus 2*10mm margins = 190mm
          wrapper.style.width = "190mm";
          wrapper.style.margin = "0 auto";
          wrapper.style.boxSizing = "border-box";

          const cloneA = origEl.cloneNode(true); // ต้นฉบับ
          const cloneB = origEl.cloneNode(true); // สำเนาใบที่ 1
          const cloneC = origEl.cloneNode(true); // สำเนาใบที่ 2

          // sync live values จากต้นฉบับเข้าสู่ทุก clones
          syncInputValues(origEl, cloneA);
          syncInputValues(origEl, cloneB);
          syncInputValues(origEl, cloneC);

          // เตรียมใบที่ 1: ต้นฉบับ
          prepareCloneForExport(cloneA, "ต้นฉบับ", false);
          cloneA.style.pageBreakAfter = "always";
          cloneA.style.breakAfter = "page";

          // เตรียมใบที่ 2: สำเนาใบที่ 1
          prepareCloneForExport(cloneB, "สำเนา ", true);
          cloneB.style.pageBreakAfter = "always";
          cloneB.style.breakAfter = "page";

          // เตรียมใบที่ 3: สำเนาใบที่ 2
          prepareCloneForExport(cloneC, "สำเนา ", true);

          // ใส่ทั้งหมดลงใน wrapper
          wrapper.appendChild(cloneA);
          wrapper.appendChild(cloneB);
          wrapper.appendChild(cloneC);

          document.body.appendChild(wrapper);
          // export the wrapper as a single PDF (2 pages)
          const opt = {
            margin: 10,
            filename: filename,
            html2canvas: { scale: 2 },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
          };
          await html2pdf().from(wrapper).set(opt).save();
          // cleanup
          wrapper.remove();
        } catch (e) {
          alert("เกิดข้อผิดพลาดขณะส่งออก: " + e);
        } finally {
          document.getElementById("docTypeLabel").textContent = "";
        }
      }

      // initialize sample items and payment method
      (function init() {
        addItem("อุปกรณ์ตัวอย่าง A", 2, 1000);
        addItem("อุปกรณ์ตัวอย่าง B", 1, 3000);
        setPaymentMethod();
      })();
    </script>
  </body>
</html>
